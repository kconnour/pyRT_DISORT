
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Spacecraft Retrieval &#8212; pyRT_DISORT  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'rst/for-users/guides/spacecraft_retrieval';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="About pyRT_DISORT" href="../../about-this-project/about-pyRT_DISORT.html" />
    <link rel="prev" title="Variables" href="variables.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    <p class="title logo__title">pyRT_DISORT  documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api-reference.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../guides.html">
                        Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/about-pyRT_DISORT.html">
                        About pyRT_DISORT
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/about-DISORT.html">
                        About DISORT
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/release-notes.html">
                        Release notes
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/kconnour/pyRT_DISORT" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../installation.html">
                        Installation
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api-reference.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../guides.html">
                        Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/about-pyRT_DISORT.html">
                        About pyRT_DISORT
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/about-DISORT.html">
                        About DISORT
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../about-this-project/release-notes.html">
                        Release notes
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/kconnour/pyRT_DISORT" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Variables</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="variables.html">Variables</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Retrievals</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spacecraft Retrieval</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../guides.html" class="nav-link">Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Spacecraft Retrieval</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="spacecraft-retrieval">
<h1>Spacecraft Retrieval<a class="headerlink" href="#spacecraft-retrieval" title="Permalink to this heading">#</a></h1>
<p>This tutorial will walk you through how to simulate reflectance spectra of an
atmosphere containing Martian dust as observed from an orbiter. Then, we’ll use
these simulations to perform a retrieval.</p>
<p>For all of this, I assume pyRT_DISORT is imported</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyrt</span>
<span class="kn">import</span> <span class="nn">disort</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All code used in this example is collected in a script located at
~/pyRT_DISORT/docs_source/rst/for-users/guides/spacecraft_retrieval.py</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Variables defined in all caps will be the ones that we ultimately plug into
the DISORT call, and they adhere to the same naming convention that DISORT
uses (for the benefit of those who have worked with DISORT before).</p>
</div>
<section id="angles">
<h2>Angles<a class="headerlink" href="#angles" title="Permalink to this heading">#</a></h2>
<p>Let’s begin by assuming we have a hyperspectral imager on an orbiter that takes
2D images such that the data have shape (15, 20) and each pixel in this grid
contains the same 5 wavelengths. Real data might have more pixels and more
wavelengths, but the scenario seems plausible enough.</p>
<p>Each pixel will have its own unique combination of incidence, emission, and phase
angles—angles that don’t depend on wavelength. Let’s create a set of angles
defined in each of these 300 pixels to use in this example (for simplicity of
the example, let’s assume that all three of these angles are the same).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">dummy_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">15</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The angles must be in degrees.</p>
</div>
<p>In this scenario, we need to make the azimuth angles of each pixel. We can do
that with <a class="reference internal" href="../generated/pyrt.azimuth.html#pyrt.azimuth" title="pyrt.azimuth"><code class="xref py py-func docutils literal notranslate"><span class="pre">azimuth()</span></code></a>. Let’s go ahead and do that, and create the
other angular variables needed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">UMU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dummy_angles</span><span class="p">))</span>   <span class="c1"># since dummy_angles is emission</span>
<span class="n">UMU0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">dummy_angles</span><span class="p">))</span>   <span class="c1"># since dummy_angles is incidence</span>
<span class="n">PHI</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">azimuth</span><span class="p">(</span><span class="n">dummy_angles</span><span class="p">,</span> <span class="n">dummy_angles</span><span class="p">,</span> <span class="n">dummy_angles</span><span class="p">)</span>
<span class="n">PHI0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">PHI</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>This computes all of the angular quantities for the same time at each pixel.
DISORT expects the input of <code class="code docutils literal notranslate"><span class="pre">UMU0</span></code> and <code class="code docutils literal notranslate"><span class="pre">PHI0</span></code> to be floats, which
we can obtain by choosing the pixel’s indices. It expects <code class="code docutils literal notranslate"><span class="pre">UMU</span></code> and
<code class="code docutils literal notranslate"><span class="pre">PHI</span></code> to both be 1D arrays (here, both are length 1 since, again, each
pixel has only 1 set of emission and azimuth angles) which we got the same way.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">UMU</span> <span class="o">=</span> <span class="n">UMU</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">UMU0</span> <span class="o">=</span> <span class="n">UMU0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">PHI</span> <span class="o">=</span> <span class="n">PHI</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">PHI0</span> <span class="o">=</span> <span class="n">PHI0</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the case where DISORT wants a 1D array, you can give it a scalar value
and f2py will convert it to an array when DISORT is called.</p>
</div>
</section>
<section id="wavelengths">
<h2>Wavelengths<a class="headerlink" href="#wavelengths" title="Permalink to this heading">#</a></h2>
<p>Let’s now turn our attention to the spectral information provided by the
instrument. I’ll define some wavelengths so we have some values to work with.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pixel_wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="mi">5</span>
<span class="n">spectral_width</span> <span class="o">=</span> <span class="mf">0.05</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>The wavelengths must be in microns.</p>
</div>
<p>If we want the wavenumbers (if, for instance, we want to include thermal
emission) we can compute them here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">WVNMHI</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">(</span><span class="n">pixel_wavelengths</span> <span class="o">-</span> <span class="n">spectral_width</span><span class="p">)</span>
<span class="n">WVNMLO</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">wavenumber</span><span class="p">(</span><span class="n">pixel_wavelengths</span> <span class="o">+</span> <span class="n">spectral_width</span><span class="p">)</span>
</pre></div>
</div>
<p>These spectral quantities have shape (5,)—the same as the input wavelengths.
For now, I’ll keep the spectral dimension but be aware that we’ll cut off the
spectral dimension closer to when we do the simulation because DISORT requires
a separate call for each wavelength.</p>
</section>
<section id="equation-of-state">
<h2>Equation of state<a class="headerlink" href="#equation-of-state" title="Permalink to this heading">#</a></h2>
<p>Let’s now start creating the atmospheric model. We’ll start by creating the
model boundaries and equation of state variables.</p>
<p>Suppose we have a pressure and temperature profile for a given pixel, along with
the altitudes where these are defined.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">altitude_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">pressure_profile</span> <span class="o">=</span> <span class="mi">500</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">altitude_grid</span> <span class="o">/</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">temperature_profile</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">mass</span> <span class="o">=</span> <span class="mf">7.3</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">26</span>
<span class="n">gravity</span> <span class="o">=</span> <span class="mf">3.7</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>To keep with DISORT’s convention that altitudes start from the top of the
atmosphere, the altitude and altitude grid must be <em>decreasing</em>.</p>
</div>
<p>If the hydrostatic approximation is adequate, we can create the column density
in each model layer, which we’ll happen to need to compute the Rayleigh
scattering optical depth in each model layer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">column_density</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">column_density</span><span class="p">(</span><span class="n">pressure_profile</span><span class="p">,</span> <span class="n">temperature_profile</span><span class="p">,</span> <span class="n">altitude_grid</span><span class="p">)</span>
</pre></div>
</div>
<p>We can also make some variables that DISORT needs in special cases.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">TEMPER</span> <span class="o">=</span> <span class="n">temperature_profile</span>
<span class="n">H_LYR</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">scale_height</span><span class="p">(</span><span class="n">temperature_profile</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="n">gravity</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="rayleigh-scattering">
<h2>Rayleigh scattering<a class="headerlink" href="#rayleigh-scattering" title="Permalink to this heading">#</a></h2>
<p>Now that we know the boundaries of our model, let’s start building it. What
we’ll do is essentially create atmospheric arrays for Rayleigh scattering, then
do the same thing with dust, and then combine them to get the total model
arrays.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rayleigh_co2</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">rayleigh_co2</span><span class="p">(</span><span class="n">column_density</span><span class="p">,</span> <span class="n">pixel_wavelengths</span><span class="p">)</span>
</pre></div>
</div>
<p>This creates a Column, which is pyRT_DISORT’s fundamental object. It collects
the optical depth, single scattering albedo, and phase function of each
atmospheric constituent. We can access these arrays via the object’s properties.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rayleigh_co2</span><span class="o">.</span><span class="n">optical_depth</span>
<span class="n">rayleigh_co2</span><span class="o">.</span><span class="n">single_scattering_albedo</span>
<span class="n">rayleigh_co2</span><span class="o">.</span><span class="n">legendre_coefficients</span>
</pre></div>
</div>
<p>These arrays have shapes (14, 5), (14, 5), and (3, 14, 5)—the same shapes
DISORT expects for <code class="docutils literal notranslate"><span class="pre">DTAUC</span></code>, <code class="docutils literal notranslate"><span class="pre">SSALB</span></code>, and <code class="docutils literal notranslate"><span class="pre">PMOM</span></code> but with an extra
wavelength dimension tacked on to the end. This class computed the arrays
at all wavelengths at once, so don’t get tripped up when computing these
composite arrays.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want to see the total optical depth due to Rayleigh scattering at
the input wavelengths, you can execute the line</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rayleigh_co2</span><span class="o">.</span><span class="n">optical_depth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>to see the column integrated optical depth. For this example it gives
<code class="docutils literal notranslate"><span class="pre">[1.62009710e-04</span> <span class="pre">1.00123336e-05</span> <span class="pre">1.97362248e-06</span> <span class="pre">6.23917610e-07</span> <span class="pre">2.55522160e-07]</span></code></p>
</div>
</section>
<section id="aerosols">
<h2>Aerosols<a class="headerlink" href="#aerosols" title="Permalink to this heading">#</a></h2>
<p>We just created 3 arrays for Rayleigh scattering; now, we need to make the same
arrays for dust.</p>
<section id="vertical-profile">
<h3>Vertical profile<a class="headerlink" href="#vertical-profile" title="Permalink to this heading">#</a></h3>
<p>First, we need to define a vertical volumetric mixing ratio profile for dust.
Let’s use a Conrath pfoiel. For our retrieval, this
profile will be used to define the aerosol weighting within the <em>layers</em>. Let’s
assume the midpoint altitudes are a good representation of the layer altitudes
and construct them here.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">altitude_midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">altitude_grid</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">altitude_grid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
<p>We can then set the Conrath parameters and construct a profile.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">q0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="n">dust_profile</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">conrath</span><span class="p">(</span><span class="n">altitude_midpoint</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">nu</span><span class="p">)</span>
</pre></div>
</div>
<p>With this profile, we can start to construct the dust’s forward scattering
properties.</p>
</section>
<section id="forward-scattering-properties">
<h3>Forward scattering properties<a class="headerlink" href="#forward-scattering-properties" title="Permalink to this heading">#</a></h3>
<p>Next, we need the dust’s forward scattering properties. I don’t include any
forward scattering properties with pyRT_DISORT; instead I presume you’ve
computed these with some T-matrix computations. Normally, you’d read these in
but here I’ll define some dummy properties.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">particle_size_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">wavelength_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">extinction_cross_section</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">scattering_cross_section</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.5</span>
</pre></div>
</div>
<p>I leave it up to you to use scipy’s <a class="reference external" href="https://docs.scipy.org/doc/scipy/tutorial/interpolate.html">interpolation routines</a> if you want to
interpolate the properties onto another grid, but I’ll assume what I defined
above is the result of the interpolation (or good enough).</p>
<p>We then need to define the particle size gradient for each model layer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">particle_size_gradient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">altitude_midpoint</span><span class="p">))</span>
</pre></div>
</div>
<p>From this, we can now compute the dust’s optical depth. Let’s suppose
(presumably because someone else told us so) that the
column-integrated optical depth is 1 at 9.3 microns. We can compute the
extinction ratio between 9.3 microns and the wavelengths of our T-matrix grid,
regrid this array onto the altitude and wavelength grid of our model, and then
use atmospheric properties to get the optical depth in each model layer at each
wavelength.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ext</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">extinction_ratio</span><span class="p">(</span><span class="n">extinction_cross_section</span><span class="p">,</span> <span class="n">particle_size_grid</span><span class="p">,</span> <span class="n">wavelength_grid</span><span class="p">,</span> <span class="mf">9.3</span><span class="p">)</span>
<span class="n">ext</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">particle_size_grid</span><span class="p">,</span> <span class="n">wavelength_grid</span><span class="p">,</span> <span class="n">particle_size_gradient</span><span class="p">,</span> <span class="n">pixel_wavelengths</span><span class="p">)</span>
<span class="n">dust_optical_depth</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">optical_depth</span><span class="p">(</span><span class="n">dust_profile</span><span class="p">,</span> <span class="n">column_density</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">dust_optical_depth</span></code> has a shape of (14, 5), meaning it’s the
optical depth of each model layer, computed at all model wavelengths.</p>
<p>The single scattering albedo is a bit simpler to compute.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dust_single_scattering_albedo</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">scattering_cross_section</span> <span class="o">/</span> <span class="n">extinction_cross_section</span><span class="p">,</span> <span class="n">particle_size_grid</span><span class="p">,</span> <span class="n">wavelength_grid</span><span class="p">,</span> <span class="n">particle_size_gradient</span><span class="p">,</span> <span class="n">pixel_wavelengths</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="legendre-coefficients">
<h3>Legendre coefficients<a class="headerlink" href="#legendre-coefficients" title="Permalink to this heading">#</a></h3>
<p>The Legendre coefficients essentially work the same way as above. I presume you
have these from the T-matrix computations, though I provide functions to
decompose phase functions into its Legendre moments. I also provide functions
for working with a Henyey-Greenstein phase function.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dust_pmom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">128</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>

<span class="n">dust_legendre</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">dust_pmom</span><span class="p">,</span> <span class="n">particle_size_grid</span><span class="p">,</span> <span class="n">wavelength_grid</span><span class="p">,</span> <span class="n">particle_size_gradient</span><span class="p">,</span> <span class="n">pixel_wavelengths</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="column">
<h3>Column<a class="headerlink" href="#column" title="Permalink to this heading">#</a></h3>
<p>As a last step for dust, let’s bundle all these properties together in a Column.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dust_column</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">dust_optical_depth</span><span class="p">,</span> <span class="n">dust_single_scattering_albedo</span><span class="p">,</span> <span class="n">dust_legendre</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="atmospheric-model">
<h2>Atmospheric model<a class="headerlink" href="#atmospheric-model" title="Permalink to this heading">#</a></h2>
<p>We’ve done the hard work of creating all the atmospheric arrays for the
individual constituents. Now we just need to put everything together, which we
can do by adding the columns together. We’ve constructed the columns for each
of the atmospheric constituents, so we just need to construct a composite
atmospheric model. All the composite arrays are stored in the object’s
properties.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">rayleigh_co2</span> <span class="o">+</span> <span class="n">dust_column</span>

<span class="n">DTAUC</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">optical_depth</span>
<span class="n">SSALB</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">single_scattering_albedo</span>
<span class="n">PMOM</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">legendre_coefficients</span>
</pre></div>
</div>
</section>
<section id="computational-parameters">
<h2>Computational parameters<a class="headerlink" href="#computational-parameters" title="Permalink to this heading">#</a></h2>
<p>We can now set a number of computational parameters. These aren’t strictly
necessary, but are useful in the off chance we made an error when constructing
an input.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These are optional to pyRT_DISORT because it can infer them from array shapes
when DISORT is called. They are not optional in the original FORTRAN
implementation.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MAXCLY</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">altitude_midpoint</span><span class="p">)</span>
<span class="n">MAXMOM</span> <span class="o">=</span> <span class="n">PMOM</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">MAXCMU</span> <span class="o">=</span> <span class="mi">16</span>      <span class="c1"># AKA the number of streams</span>
<span class="n">MAXPHI</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MAXUMU</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MAXULV</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">altitude_midpoint</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</pre></div>
</div>
<p>The geometry of this situation dictates that the number of azimuth and polar
angles are both 1. The number of Legendre coefficients from the T-matrix
computations set the number of moments. The vertical grid set the number of
computational layers and user levels. The number of streams can be changed.</p>
</section>
<section id="model-behavior">
<h2>Model behavior<a class="headerlink" href="#model-behavior" title="Permalink to this heading">#</a></h2>
<p>We can also set how we want the model to behave. These are some example values
but you can change these to your liking</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ACCUR</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">DELTAMPLUS</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">DO_PSEUDO_SPHERE</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">HEADER</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">PRNT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">EARTH_RADIUS</span> <span class="o">=</span> <span class="mi">6371</span>
</pre></div>
</div>
</section>
<section id="radiation">
<h2>Radiation<a class="headerlink" href="#radiation" title="Permalink to this heading">#</a></h2>
<p>Let’s now specify the flux and thermal quantities used in the model.</p>
<section id="incident-flux">
<h3>Incident flux<a class="headerlink" href="#incident-flux" title="Permalink to this heading">#</a></h3>
<p>We can define the beam flux and the isotropic flux at the top of the atmosphere.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FBEAM</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">FISOT</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>At least for our Martian simulation, there’s no real need to worry about the
isotropic flux from space.</p>
</section>
<section id="thermal-emission">
<h3>Thermal emission<a class="headerlink" href="#thermal-emission" title="Permalink to this heading">#</a></h3>
<p>We can also define whether thermal emission is used in the model. For this
example, we’ll ignore thermal emission but this code snippet shows how you
may define some variables. If no thermal emission is used, the other variables
can be any floats.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">PLANK</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">BTEMP</span> <span class="o">=</span> <span class="n">temperature_profile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">TTEMP</span> <span class="o">=</span> <span class="n">temperature_profile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">TEMIS</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
</section>
</section>
<section id="output">
<h2>Output<a class="headerlink" href="#output" title="Permalink to this heading">#</a></h2>
<section id="arrays">
<h3>Arrays<a class="headerlink" href="#arrays" title="Permalink to this heading">#</a></h3>
<p>Next, we’ll create some output arrays. DISORT evidently needs these empty arrays
to be initialized and it’ll fill them as it runs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ALBMED</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_albedo_medium</span><span class="p">(</span><span class="n">MAXUMU</span><span class="p">)</span>
<span class="n">FLUP</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_diffuse_up_flux</span><span class="p">(</span><span class="n">MAXULV</span><span class="p">)</span>
<span class="n">RFLDN</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_diffuse_down_flux</span><span class="p">(</span><span class="n">MAXULV</span><span class="p">)</span>
<span class="n">RFLDIR</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_direct_beam_flux</span><span class="p">(</span><span class="n">MAXULV</span><span class="p">)</span>
<span class="n">DFDT</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_flux_divergence</span><span class="p">(</span><span class="n">MAXULV</span><span class="p">)</span>
<span class="n">UU</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_intensity</span><span class="p">(</span><span class="n">MAXUMU</span><span class="p">,</span> <span class="n">MAXULV</span><span class="p">,</span> <span class="n">MAXPHI</span><span class="p">)</span>
<span class="n">UAVG</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_mean_intensity</span><span class="p">(</span><span class="n">MAXULV</span><span class="p">)</span>
<span class="n">TRNMED</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">empty_transmissivity_medium</span><span class="p">(</span><span class="n">MAXUMU</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="behavior">
<h3>Behavior<a class="headerlink" href="#behavior" title="Permalink to this heading">#</a></h3>
<p>We have yet more switches to tell DISORT how to run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">IBCND</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">ONLYFL</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">USRANG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">USRTAU</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</section>
</section>
<section id="surface">
<h2>Surface<a class="headerlink" href="#surface" title="Permalink to this heading">#</a></h2>
<p>With the number of computational parameters defined, we can now make the
arrays of the surface reflectance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sfc</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">n_streams</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">n_polar</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">n_azimuth</span><span class="p">,</span> <span class="n">ob</span><span class="o">.</span><span class="n">user_angles</span><span class="p">,</span>
              <span class="n">ob</span><span class="o">.</span><span class="n">only_fluxes</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="code docutils literal notranslate"><span class="pre">sfc</span></code> doesn’t know what <em>kind</em> of surface it is. We can then set the type
of surface using the methods in <code class="code docutils literal notranslate"><span class="pre">Surface</span></code>. For simplicity, let’s use a
Lambertian surface here. Once that’s set, this class computes all the arrays it
needs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sfc</span><span class="o">.</span><span class="n">make_lambertian</span><span class="p">()</span>

<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">albedo</span>
<span class="n">LAMBER</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">lambertian</span>
<span class="n">RHOU</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">rhou</span>
<span class="n">RHOQ</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">rhoq</span>
<span class="n">BEMST</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">bemst</span>
<span class="n">EMUST</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">emust</span>
<span class="n">RHO_ACCURATE</span> <span class="o">=</span> <span class="n">sfc</span><span class="o">.</span><span class="n">rho_accurate</span>
</pre></div>
</div>
<p>With these defined, we’ve now created all the variables that DISORT needs!</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><code class="code docutils literal notranslate"><span class="pre">Surface</span></code> also comes with <code class="xref py py-meth docutils literal notranslate"><span class="pre">make_hapke()</span></code>,
<code class="xref py py-meth docutils literal notranslate"><span class="pre">make_hapkeHG2()</span></code>, and
<code class="xref py py-meth docutils literal notranslate"><span class="pre">make_hapkeHG2_roughness()</span></code> if you want to use more
complicated phase functions. The 5 surface arrays are initialized with 0s
when the class is instantiated. When these methods are called, those arrays
are overridden.</p>
<p>For a brief example, suppose you want to use a Hapke surface (without the
surface HG phase function) and you know the Hapke parameters. You can do
that with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">b0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">h</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">w</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">sfc</span><span class="o">.</span><span class="n">make_hapke</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">UMU</span><span class="p">,</span> <span class="n">UMU0</span><span class="p">,</span> <span class="n">PHI</span><span class="p">,</span> <span class="n">PHI0</span><span class="p">,</span> <span class="n">FBEAM</span><span class="p">)</span>
</pre></div>
</div>
<p>and then all the arrays will be populated with values from a Hapke surface.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Making the surface phase functions were the one place where I modified the
DISORT source code. The shape of <code class="code docutils literal notranslate"><span class="pre">RHOU</span></code> seems wrong and inconsistent
throughout the DISORT documentation. When I make it what I think it should
be, my code then runs without error. However, it seems an error like this
would’ve gone unnoticed, so be aware of this!</p>
</div>
</section>
<section id="oddball">
<h2>Oddball<a class="headerlink" href="#oddball" title="Permalink to this heading">#</a></h2>
<p>This one doesn’t fit in with the others in my mind. If we want the radiant
quantities to be returned at user-specified boundaries, we need to tell DISORT
what those boundaries are. If we don’t specify these, it’ll return them at the
layers of our model, which is perfectly fine in this case.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">UTAU</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAXULV</span><span class="p">,))</span>
</pre></div>
</div>
</section>
<section id="running-the-model">
<h2>Running the model<a class="headerlink" href="#running-the-model" title="Permalink to this heading">#</a></h2>
<p>We have all the variables we need to simulate some reflectance curves. Recall
that we’ve been making properties (where applicable) at all 5 wavelengths at
once. Unfortunately DISORT can’t natively handle this, so we need to loop over
wavelength. I’ll import the necessary module and create an array that’ll be
filled as DISORT runs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">test_run</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pixel_wavelengths</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
<p>Once we carefully put all ~50 variables in the correct order and remember to
only select parts of the arrays we need (slicing off the wavelength dimension),
we can do simulations.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pixel_wavelengths</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
    <span class="n">rfldir</span><span class="p">,</span> <span class="n">rfldn</span><span class="p">,</span> <span class="n">flup</span><span class="p">,</span> <span class="n">dfdt</span><span class="p">,</span> <span class="n">uavg</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">albmed</span><span class="p">,</span> <span class="n">trnmed</span> <span class="o">=</span> \
        <span class="n">disort</span><span class="o">.</span><span class="n">disort</span><span class="p">(</span><span class="n">USRANG</span><span class="p">,</span> <span class="n">USRTAU</span><span class="p">,</span> <span class="n">IBCND</span><span class="p">,</span> <span class="n">ONLYFL</span><span class="p">,</span> <span class="n">PRNT</span><span class="p">,</span> <span class="n">PLANK</span><span class="p">,</span> <span class="n">LAMBER</span><span class="p">,</span>
                      <span class="n">DELTAMPLUS</span><span class="p">,</span> <span class="n">DO_PSEUDO_SPHERE</span><span class="p">,</span> <span class="n">DTAUC</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span> <span class="n">SSALB</span><span class="p">[:,</span> <span class="n">ind</span><span class="p">],</span>
                      <span class="n">PMOM</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ind</span><span class="p">],</span> <span class="n">TEMPER</span><span class="p">,</span> <span class="n">WVNMLO</span><span class="p">,</span> <span class="n">WVNMHI</span><span class="p">,</span>
                      <span class="n">UTAU</span><span class="p">,</span> <span class="n">UMU0</span><span class="p">,</span> <span class="n">PHI0</span><span class="p">,</span> <span class="n">UMU</span><span class="p">,</span> <span class="n">PHI</span><span class="p">,</span> <span class="n">FBEAM</span><span class="p">,</span> <span class="n">FISOT</span><span class="p">,</span>
                      <span class="n">ALBEDO</span><span class="p">,</span> <span class="n">BTEMP</span><span class="p">,</span> <span class="n">TTEMP</span><span class="p">,</span> <span class="n">TEMIS</span><span class="p">,</span> <span class="n">EARTH_RADIUS</span><span class="p">,</span> <span class="n">H_LYR</span><span class="p">,</span> <span class="n">RHOQ</span><span class="p">,</span> <span class="n">RHOU</span><span class="p">,</span>
                      <span class="n">RHO_ACCURATE</span><span class="p">,</span> <span class="n">BEMST</span><span class="p">,</span> <span class="n">EMUST</span><span class="p">,</span> <span class="n">ACCUR</span><span class="p">,</span> <span class="n">HEADER</span><span class="p">,</span> <span class="n">RFLDIR</span><span class="p">,</span>
                      <span class="n">RFLDN</span><span class="p">,</span> <span class="n">FLUP</span><span class="p">,</span> <span class="n">DFDT</span><span class="p">,</span> <span class="n">UAVG</span><span class="p">,</span> <span class="n">UU</span><span class="p">,</span> <span class="n">ALBMED</span><span class="p">,</span> <span class="n">TRNMED</span><span class="p">)</span>

    <span class="n">test_run</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">=</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">test_run</span><span class="p">)</span>
</pre></div>
</div>
<p>This prints <code class="code docutils literal notranslate"><span class="pre">[0.11399675</span> <span class="pre">0.06681997</span> <span class="pre">0.06493594</span> <span class="pre">0.06464735</span> <span class="pre">0.06458137]</span></code>.</p>
</section>
<section id="retrieval">
<h2>Retrieval<a class="headerlink" href="#retrieval" title="Permalink to this heading">#</a></h2>
<p>We were able to make simulations in the previous section, but now let’s suppose
we want to retrieve the dust optical depth (instead of treating it as a fixed
quantity). All that we really need to do is run simulations with a bunch of
different optical depths and see which one matches an observation the best
… though the implementation details aren’t quite so crude. To demonstrate how
to do this, let’s suppose the result of our simulation above where the dust
optical depth was 1 was a measured quantity and let’s also pretend we have no
idea what the dust optical depth is.</p>
<p>The simulated spectrum acts as our measured I/F.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">rfl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.11399675</span><span class="p">,</span> <span class="mf">0.06681997</span><span class="p">,</span> <span class="mf">0.06493594</span><span class="p">,</span> <span class="mf">0.06464735</span><span class="p">,</span> <span class="mf">0.06458137</span><span class="p">])</span>
</pre></div>
</div>
<p>If we want to retrieve a scalar optical depth over this spectral range
we want a function that accepts a test optical depth and finds the optical
depth that best fits this spectrum. The following function does that</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">simulate_spectra</span><span class="p">(</span><span class="n">test_optical_depth</span><span class="p">):</span>
    <span class="n">dust_optical_depth</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">optical_depth</span><span class="p">(</span><span class="n">dust_profile</span><span class="p">,</span> <span class="n">column_density</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">test_optical_depth</span><span class="p">)</span>
    <span class="n">dust_column</span> <span class="o">=</span> <span class="n">pyrt</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">dust_optical_depth</span><span class="p">,</span> <span class="n">dust_single_scattering_albedo</span><span class="p">,</span> <span class="n">dust_legendre</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">rayleigh_co2</span> <span class="o">+</span> <span class="n">dust_column</span>

    <span class="n">od_holder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_wavelengths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">wav_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_wavelengths</span><span class="p">):</span>
        <span class="n">rfldir</span><span class="p">,</span> <span class="n">rfldn</span><span class="p">,</span> <span class="n">flup</span><span class="p">,</span> <span class="n">dfdt</span><span class="p">,</span> <span class="n">uavg</span><span class="p">,</span> <span class="n">uu</span><span class="p">,</span> <span class="n">albmed</span><span class="p">,</span> <span class="n">trnmed</span> <span class="o">=</span> \
             <span class="n">disort</span><span class="o">.</span><span class="n">disort</span><span class="p">(</span><span class="n">USRANG</span><span class="p">,</span> <span class="n">USRTAU</span><span class="p">,</span> <span class="n">IBCND</span><span class="p">,</span> <span class="n">ONLYFL</span><span class="p">,</span> <span class="n">PRNT</span><span class="p">,</span> <span class="n">PLANK</span><span class="p">,</span> <span class="n">LAMBER</span><span class="p">,</span>
                      <span class="n">DELTAMPLUS</span><span class="p">,</span> <span class="n">DO_PSEUDO_SPHERE</span><span class="p">,</span> <span class="n">DTAUC</span><span class="p">[:,</span> <span class="n">wav_index</span><span class="p">],</span> <span class="n">SSALB</span><span class="p">[:,</span> <span class="n">wav_index</span><span class="p">],</span>
                      <span class="n">PMOM</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">wav_index</span><span class="p">],</span> <span class="n">TEMPER</span><span class="p">,</span> <span class="n">WVNMLO</span><span class="p">,</span> <span class="n">WVNMHI</span><span class="p">,</span>
                      <span class="n">UTAU</span><span class="p">,</span> <span class="n">UMU0</span><span class="p">,</span> <span class="n">PHI0</span><span class="p">,</span> <span class="n">UMU</span><span class="p">,</span> <span class="n">PHI</span><span class="p">,</span> <span class="n">FBEAM</span><span class="p">,</span> <span class="n">FISOT</span><span class="p">,</span>
                      <span class="n">ALBEDO</span><span class="p">,</span> <span class="n">BTEMP</span><span class="p">,</span> <span class="n">TTEMP</span><span class="p">,</span> <span class="n">TEMIS</span><span class="p">,</span> <span class="n">EARTH_RADIUS</span><span class="p">,</span> <span class="n">H_LYR</span><span class="p">,</span> <span class="n">RHOQ</span><span class="p">,</span> <span class="n">RHOU</span><span class="p">,</span>
                      <span class="n">RHO_ACCURATE</span><span class="p">,</span> <span class="n">BEMST</span><span class="p">,</span> <span class="n">EMUST</span><span class="p">,</span> <span class="n">ACCUR</span><span class="p">,</span> <span class="n">HEADER</span><span class="p">,</span> <span class="n">RFLDIR</span><span class="p">,</span>
                      <span class="n">RFLDN</span><span class="p">,</span> <span class="n">FLUP</span><span class="p">,</span> <span class="n">DFDT</span><span class="p">,</span> <span class="n">UAVG</span><span class="p">,</span> <span class="n">UU</span><span class="p">,</span> <span class="n">ALBMED</span><span class="p">,</span> <span class="n">TRNMED</span><span class="p">)</span>

        <span class="n">od_holder</span><span class="p">[</span><span class="n">wav_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">uu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">od_holder</span> <span class="o">-</span> <span class="n">rfl</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>If I only want to retrieve the dust optical depth, nothing in this guide before the place where
I define the optical depth is affected; that is, the equation of state,
input angles, input wavelengths, etc. don’t need modification. In fact, only
the atmospheric model cares about the different optical depths.
I create an empty array that will hold the values
as DISORT is run at each of the wavelengths (just like before) and populate
it along the way, but I only return the square of the distance from the target
spectrum. This essentially tells us how close the input optical depth is to the
target. If we minimize the output of this function, we found the best fit dust
optical depth.</p>
<p>Fortunately, scipy has some minimization routines for just this sort of thing.
I’ll use their Nelder-Mead algorithm (a slower but robust algorithm) but feel
free to use another one if you’ve got more familiarity with them. All we need
to do is provide it a function to minimize (which we just defined) along with
an initial guess. This particular algorithm also has some bounds so I can tell
it not to try negative optical depths.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>


<span class="k">def</span> <span class="nf">retrieve_od</span><span class="p">(</span><span class="n">guess</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">simulate_spectra</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">guess</span><span class="p">]),</span>
                             <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">x</span>
</pre></div>
</div>
<p>Now let’s do a retrieval where we guess that the optical depth is 1.5 and see
how it performs, along with how long it takes to run.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">retrieve_od</span><span class="p">(</span><span class="mf">1.5</span><span class="p">))</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The retrieval took </span><span class="si">{</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="p">)</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> seconds.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>On my computer this outputs</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mf">0.99997559</span><span class="p">]</span>
<span class="n">The</span> <span class="n">retrieval</span> <span class="n">took</span> <span class="mf">0.351</span> <span class="n">seconds</span><span class="o">.</span>
</pre></div>
</div>
<p>Seems decent to me.</p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="variables.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Variables</p>
      </div>
    </a>
    <a class="right-next"
       href="../../about-this-project/about-pyRT_DISORT.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">About pyRT_DISORT</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#angles">Angles</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#wavelengths">Wavelengths</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#equation-of-state">Equation of state</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rayleigh-scattering">Rayleigh scattering</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aerosols">Aerosols</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vertical-profile">Vertical profile</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forward-scattering-properties">Forward scattering properties</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#legendre-coefficients">Legendre coefficients</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#column">Column</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#atmospheric-model">Atmospheric model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#computational-parameters">Computational parameters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#model-behavior">Model behavior</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#radiation">Radiation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#incident-flux">Incident flux</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#thermal-emission">Thermal emission</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#output">Output</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#arrays">Arrays</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#behavior">Behavior</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#surface">Surface</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#oddball">Oddball</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#running-the-model">Running the model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#retrieval">Retrieval</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../../../_sources/rst/for-users/guides/spacecraft_retrieval.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, kconnour.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.0.1.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>